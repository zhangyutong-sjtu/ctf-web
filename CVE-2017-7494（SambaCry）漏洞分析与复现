### CVE-2017-7494（SambaCry）漏洞分析与复现

#### 漏洞描述

Samba 3.5.0及4.6.4、4.5.10和4.4.14之前的版本容易受到远程代码执行漏洞的攻击，允许恶意客户端将共享库上传到可写共享，然后导致服务器加载并执行它。

| 漏洞基本信息 |                                                              |
| ------------ | ------------------------------------------------------------ |
| 漏洞ID       | CVE-2017-7494                                                |
| 漏洞名称     | Samba远程代码执行漏洞                                        |
| 漏洞类型     | 远程代码执行                                                 |
| 触发条件     | 拥有服务器共享目录的访问（写入）权限； 知道共享目录的物理路径 |
| 漏洞危害     | 恶意访问者可以远程执行高权限命令                             |
| 影响版本     | – 3.5.0- 4.6.4   – 3.5.0- 4.5.10     – 3.5.0- 4.4.14         |

#### 漏洞评分

![image-20240312182223154](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240312182223154.png)

#### 漏洞原理

Samba是在Linux和Unix系统上实现Smb协议的一个免费软件，由服务器及客户端程序构成，Samba服务对应的TCP端口有139、445等。Smb一般作为文件共享服务器，专门提供Linux与Windows之间的传送文件服务。

Samba允许连接一个远程的命名管道，并且在连接前会调用处于\source3\rpc_server\src_pipe.c的is_known_pipename()函数验证管道名称是否合法。该模块需要有效的凭证，可访问共享中的可写文件夹，以及可写文件夹的服务器端路径的知识。在is_known_pipename()函数中，并不检查管道名称中的特殊字符（路径分隔符/），就加载使用该名称的动态链接库。导致攻击者可以构造一个恶意的动态链接库文件，执行任意代码。因此在某些情况下，可以使用匿名访问和公共文件系统位置相结合来自动利用此漏洞。

```
//is_known_pipename()函数源码
bool is_known_pipename(const char *pipename, struct ndr_syntax_id *syntax)
{
	NTSTATUS status;

	if (lp_disable_spoolss() &amp;&amp; strequal(pipename, "spoolss")) {
		DEBUG(10, ("refusing spoolss access\n"));
		return false;
	}

	if (rpc_srv_get_pipe_interface_by_cli_name(pipename, syntax)) {
		return true;
	}

	status = smb_probe_module("rpc", pipename);
	#pipe_name加载module
	if (!NT_STATUS_IS_OK(status)) {
		DEBUG(10, ("is_known_pipename: %s unknown\n", pipename));
		return false;
	}
	DEBUG(10, ("is_known_pipename: %s loaded dynamically\n", pipename));

	/*
	 * Scan the list again for the interface id
	 */
	if (rpc_srv_get_pipe_interface_by_cli_name(pipename, syntax)) {
		return true;
	}

	DEBUG(10, ("is_known_pipename: pipe %s did not register itself!\n",
		   pipename));

	return false;
}
```



#### 漏洞复现

1. 实验设备

   靶机：kali-linux虚拟机2017.1(ip为192.168.137.251)

   ![image-20240313125043409](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313125043409.png)

   攻击机：kali-linux虚拟机2018.4(ip为192.168.137.77)

   ![image-20240313125915972](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313125915972.png)

2. 首先，查看靶机的Samba版本：

   ![image-20240312195820546](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240312195820546.png)

   该版本为具有CVE-2017-7494漏洞的版本

3. 在靶机里创建Samba共享目录，并修改读写执行权限，创建利用CVE-2017-7494漏洞的前提

   ![image-20240312200145540](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240312200145540.png)

4. 修改靶机的Samba配置文件

   利用`vim /etc/samba/smb.conf`命令修改配置文件，如下：

   ![image-20240313105730238](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313105730238.png)

   添加共享目录配置之后，保存退出。

5. 重启靶机的samba服务，查看samba进程及端口状态（采用139和445端口）

   ```
   service smbd restart
   
   ps aux | grep samba
   
   netstat -tnlp samba
   ```

   ![image-20240313125654354](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313125654354.png)

6. 对/tmp/public设置权限777

7. 进入攻击机，使用渗透模块`msfconsole`，使用渗透模块is_known_pipename：`use exploit/linux/samba/is_known_pipename`

   ![image-20240313122250290](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313122250290.png)



8. 查看模块选项`show options`

   ![image-20240313122434744](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313122434744.png)

9. 设置目标主机（即靶机的ip地址）

   ![image-20240313130251507](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313130251507.png)

10. 执行`exploit`

    ![image-20240313130359509](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313130359509.png)

    可以看到此时kali2018通过执行渗透模块成功拿到kali2017的shell

11. 利用kali2018对kali2017执行操作控制

    （1） 查看系统信息

    ![image-20240313130723040](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313130723040.png)

    （2) 查看目录

    ![image-20240313130846719](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313130846719.png)

    （3）执行操作

    在kali2017上增加一个“test to del"文件夹

    ![image-20240313131020315](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313131020315.png)

    ![image-20240313131225380](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313131225380.png)

    在kali2018上删除它

    ![image-20240313131240989](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313131240989.png)

    ![image-20240313131346161](C:\Users\张羽桐\AppData\Roaming\Typora\typora-user-images\image-20240313131346161.png)

12. 攻击成功






参考文献：

[1] [CVE-2017-7494 : Samba since version 3.5.0 and before 4.6.4, 4.5.10 and 4.4.14 is vulnerable to remote code execution vulnerability, allo (cvedetails.com)](https://www.cvedetails.com/cve-details.php?t=1&cve_id=CVE-2017-7494)

[2] 参考教程：https://www.bilibili.com/read/cv7220520/
